{% extends "layout/base.html" %}

{% block title %}Registro{% endblock %}

{% block content %}
<div class="container my-4">
    <form class="row gx-3 gy-2 align-items-center" method="GET" action="/consultar/">
        <!-- ID Feeder para consultar datos-->
        <div class="col-md-6">
            <label for="data" class="form-label">Data</label>
            <input type="text" class="form-control" id="data" name="feeder_id" placeholder="Buscar por ID"
                maxlength="9">
        </div>

        <!-- Color de la Semana -->
        <div class="col-md-6">
            <label for="color-semana" class="form-label">Color Semana</label>
            <input type="text" class="form-control" id="color-semana" disabled />
        </div>

        <!-- ID_Feeder -->
        <div class="col-md-6">
            <label for="id-feeder" class="form-label">ID_Feeder</label>
            <input type="text" class="form-control" id="id-feeder" disabled />
        </div>
        <!-- Color Feeder -->
        <div class="col-md-6">
            <label for="color-feeder" class="form-label">Color Feeder</label>
            <input type="text" class="form-control" id="color-feeder" disabled />
        </div>

        <!-- Feeder -->
        <div class="col-md-6">
            <label for="feeder" class="form-label">Feeder</label>
            <input type="text" class="form-control" id="feeder" disabled />
        </div>
        <!-- Codigo Feeder -->
        <div class="col-md-6">
            <label for="codigo-feeder" class="form-label">Código Feeder</label>
            <input type="text" class="form-control" id="codigo-feeder" disabled />
        </div>
        <!-- Técnico -->
        <div class="col-md-6">
            <label for="tecnico" class="form-label">Técnico</label>
            <input type="text" class="form-control" id="tecnico" disabled />
        </div>

        <!-- Calibración -->
        <div class="col-md-6">
            <label class="form-label">Calibración</label>
            <canvas id="calibracion-canvas" class="w-100 border rounded" height="30"></canvas>
        </div>

        <!-- Status -->
        <div class="col-md-6">
            <label class="form-label">Status</label>
            <canvas id="status-canvas" class="w-100 border rounded" height="30"></canvas>
        </div>

        <!-- CP -->
        <div class="col-md-6">
            <label for="cp" class="form-label">CP</label>
            <select id="cp" class="form-select">
                <option value="NG">NG</option>
                <option value="OK">OK</option>
            </select>
        </div>

        <!-- QP -->
        <div class="col-md-6">
            <label for="qp" class="form-label">QP</label>
            <select id="qp" class="form-select">
                <option value="NG">NG</option>
                <option value="OK">OK</option>
            </select>
        </div>

        <!-- Hover -->
        <div class="col-md-6">
            <label for="hover" class="form-label">Hover</label>
            <select id="hover" class="form-select">
                <option value="NG">NG</option>
                <option value="OK">OK</option>
            </select>
        </div>

        <!-- BFC -->
        <div class="col-md-6">
            <label for="bfc" class="form-label">BFC</label>
            <select id="bfc" class="form-select">
                <option value="NG">NG</option>
                <option value="OK">OK</option>
            </select>
        </div>

        <!-- Observaciones -->
        <div class="col-12">
            <label for="observaciones" class="form-label">Observaciones</label>
            <textarea id="observaciones" rows="4" class="form-control"></textarea>
        </div>

        <!-- Footer -->
        <div class="col-12 text-center mt-3">
            <p class="text-muted">Created by: Cristian Echevarria</p>
        </div>
    </form>
</div>

<script>
    let debounceTimeout;  // Definir variable de debounce en el ámbito global del script

    // Manejo del evento Enter para buscar feeder info con debounce
    document.getElementById('data').addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();  // Evitar recarga de la página
            clearTimeout(debounceTimeout);  // Limpiar cualquier timeout previo
            debounceTimeout = setTimeout(fetchFeederInfo, 300);  // Esperar 300ms antes de ejecutar
        }
    });

    function showAlert(title, message, icon = 'info') {
        Swal.fire({
            title: title,
            text: message,
            icon: icon,
            confirmButtonText: 'Aceptar',
        });
    }

    function fetchFeederInfo() {
        const feederId = document.getElementById('data').value.trim();

        if (!feederId) {
            showAlert('Campo vacío', 'Por favor, introduce un ID de feeder', 'warning');
            return;  // Evitar ejecución si el campo está vacío
        }

        fetch(`/consultar/?feeder_id=${feederId}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 500) {
                        throw new Error('Feeder no encontrado. Introduce un ID de feeder correcto');
                    } else if (response.status === 400) {
                        throw new Error('Introduce un valor numérico para el ID de feeder');
                    } else {
                        throw new Error(`Error: ${response.statusText}`);
                    }
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    showAlert('Error', data.error, 'error');
                    return;
                }
                // Rellenamos los campos con los datos del feeder
                document.getElementById('id-feeder').value = data.id_feeder || '';
                document.getElementById('feeder').value = data.feeder || '';
                document.getElementById('color-feeder').value = data.color_feeder || '';
                document.getElementById('codigo-feeder').value = data.codigo_feeder || '';
                document.getElementById('color-semana').value = data.color_semana || '';
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error', error.message, 'error');
            });
    }
</script>
{% endblock %}